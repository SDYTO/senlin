#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import os
import sys
import json
import requests
from datetime import datetime
import argparse

# å…¨å±€é…ç½®
BLOG_BASE_FILE = "blogBase.json"
DOCS_DIR = "docs"
BACKUP_DIR = "backup"
ISSUE_CONTENT_KEY = "content"

def init_dirs():
    """åˆå§‹åŒ–å¿…è¦ç›®å½•ï¼ˆdocs/backupï¼‰"""
    for dir_name in [DOCS_DIR, BACKUP_DIR]:
        if not os.path.exists(dir_name):
            os.makedirs(dir_name)
            print(f"âœ… åˆ›å»ºç›®å½•ï¼š{dir_name}")

def load_blog_base():
    """åŠ è½½åšå®¢åŸºç¡€é…ç½®ï¼ˆblogBase.jsonï¼‰"""
    if os.path.exists(BLOG_BASE_FILE):
        with open(BLOG_BASE_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    else:
        # é»˜è®¤é…ç½®æ¨¡æ¿
        default_base = {
            "title": "My Gmeek Blog",
            "subtitle": "Auto-generated by Gmeek",
            "author": os.getenv("GITHUB_REPOSITORY_OWNER", "Anonymous"),
            "last_update": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "posts": []
        }
        with open(BLOG_BASE_FILE, "w", encoding="utf-8") as f:
            json.dump(default_base, f, ensure_ascii=False, indent=2)
        print(f"âœ… ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶ï¼š{BLOG_BASE_FILE}")
        return default_base

def fetch_issue_content(github_token, repo, issue_number):
    """ä» GitHub Issue è·å–å†…å®¹ï¼ˆå¦‚æœæŒ‡å®šäº† issue_numberï¼‰"""
    if not issue_number or issue_number == "":
        print("â„¹ï¸ æœªæŒ‡å®š Issue ç¼–å·ï¼Œè·³è¿‡è·å– Issue å†…å®¹")
        return None
    
    url = f"https://api.github.com/repos/{repo}/issues/{issue_number}"
    headers = {
        "Authorization": f"token {github_token}",
        "Accept": "application/vnd.github.v3+json"
    }
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        issue = response.json()
        # è¿”å› Issue çš„æ ‡é¢˜å’Œå†…å®¹
        return {
            "title": issue["title"],
            "content": issue["body"],
            "created_at": issue["created_at"],
            "updated_at": issue["updated_at"]
        }
    except Exception as e:
        print(f"âš ï¸ è·å– Issue å†…å®¹å¤±è´¥ï¼š{str(e)}")
        return None

def generate_html(blog_base, issue_content=None):
    """ç”Ÿæˆ HTML åšå®¢é¡µé¢"""
    # 1. æ›´æ–°åšå®¢åŸºç¡€ä¿¡æ¯
    blog_base["last_update"] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    # 2. å¦‚æœæœ‰ Issue å†…å®¹ï¼Œæ·»åŠ ä¸ºæ–°æ–‡ç« 
    if issue_content:
        new_post = {
            "id": len(blog_base["posts"]) + 1,
            "title": issue_content["title"],
            "content": issue_content["content"].replace("\n", "<br>"),
            "created_at": issue_content["created_at"].split("T")[0],
            "updated_at": issue_content["updated_at"].split("T")[0]
        }
        blog_base["posts"].append(new_post)
        # ä¿å­˜æ›´æ–°åçš„ blogBase.json
        with open(BLOG_BASE_FILE, "w", encoding="utf-8") as f:
            json.dump(blog_base, f, ensure_ascii=False, indent=2)
        print(f"âœ… æ–°å¢æ–‡ç« ï¼š{issue_content['title']}")
    
    # 3. ç”Ÿæˆé¦–é¡µ HTML
    html_template = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{title}</title>
    <style>
        body { max-width: 1200px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; }
        .header { text-align: center; margin-bottom: 50px; }
        .post { margin: 30px 0; padding: 20px; border-bottom: 1px solid #eee; }
        .post-title { color: #2c3e50; margin-bottom: 10px; }
        .post-meta { color: #7f8c8d; font-size: 0.9em; margin-bottom: 15px; }
        .post-content { line-height: 1.6; color: #34495e; }
        .footer { text-align: center; margin-top: 50px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="header">
        <h1>{title}</h1>
        <p>{subtitle}</p>
        <p>ä½œè€…ï¼š{author} | æœ€åæ›´æ–°ï¼š{last_update}</p>
    </div>

    <div class="posts">
        {posts_html}
    </div>

    <div class="footer">
        <p>Generated by Gmeek | <a href="https://github.com/Meekdai/Gmeek" target="_blank">Gmeek Official</a></p>
    </div>
</body>
</html>
    """
    
    # ç”Ÿæˆæ–‡ç« åˆ—è¡¨ HTML
    posts_html = ""
    for post in reversed(blog_base["posts"]):  # å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
        posts_html += f"""
        <div class="post">
            <h2 class="post-title">{post['title']}</h2>
            <div class="post-meta">åˆ›å»ºæ—¶é—´ï¼š{post['created_at']} | æ›´æ–°æ—¶é—´ï¼š{post['updated_at']}</div>
            <div class="post-content">{post['content']}</div>
        </div>
        """
    
    # å¡«å……æ¨¡æ¿å¹¶ç”Ÿæˆ index.html
    index_html = html_template.format(
        title=blog_base["title"],
        subtitle=blog_base["subtitle"],
        author=blog_base["author"],
        last_update=blog_base["last_update"],
        posts_html=posts_html
    )
    
    # ä¿å­˜åˆ° docs ç›®å½•ï¼ˆGitHub Pages éƒ¨ç½²ç›®å½•ï¼‰
    index_path = os.path.join(DOCS_DIR, "index.html")
    with open(index_path, "w", encoding="utf-8") as f:
        f.write(index_html)
    print(f"âœ… ç”Ÿæˆé¦–é¡µ HTMLï¼š{index_path}")

def backup_blog_base():
    """å¤‡ä»½ blogBase.json åˆ° backup ç›®å½•"""
    if os.path.exists(BLOG_BASE_FILE):
        backup_path = os.path.join(BACKUP_DIR, f"blogBase_{datetime.now().strftime('%Y%m%d%H%M%S')}.json")
        with open(BLOG_BASE_FILE, "r", encoding="utf-8") as f_in, open(backup_path, "w", encoding="utf-8") as f_out:
            json.dump(json.load(f_in), f_out, ensure_ascii=False, indent=2)
        print(f"âœ… å¤‡ä»½é…ç½®æ–‡ä»¶ï¼š{backup_path}")

def main():
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    parser = argparse.ArgumentParser(description="Gmeek Blog Generator")
    parser.add_argument("github_token", help="GitHub Token for API access")
    parser.add_argument("repo", help="GitHub Repository (owner/repo)")
    parser.add_argument("--issue_number", help="GitHub Issue Number to fetch content", default="")
    args = parser.parse_args()
    
    try:
        print("ğŸš€ å¼€å§‹æ‰§è¡Œ Gmeek åšå®¢ç”Ÿæˆæµç¨‹...")
        # 1. åˆå§‹åŒ–ç›®å½•
        init_dirs()
        # 2. åŠ è½½åšå®¢åŸºç¡€é…ç½®
        blog_base = load_blog_base()
        # 3. ï¼ˆå¯é€‰ï¼‰ä» Issue è·å–å†…å®¹
        issue_content = fetch_issue_content(args.github_token, args.repo, args.issue_number)
        # 4. ç”Ÿæˆ HTML é¡µé¢
        generate_html(blog_base, issue_content)
        # 5. å¤‡ä»½é…ç½®æ–‡ä»¶
        backup_blog_base()
        print("ğŸ‰ Gmeek åšå®¢ç”Ÿæˆæµç¨‹æ‰§è¡Œå®Œæˆï¼")
    except Exception as e:
        print(f"âŒ æ‰§è¡Œå¤±è´¥ï¼š{str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
